<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>marketplace documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">marketplace documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  Message</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/messages/messages.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#createdAt" 
>
                                            createdAt
                                        </a>
                                </li>
                                <li>
                                        <a href="#message" 
>
                                            message
                                        </a>
                                </li>
                                <li>
                                        <a href="#messageID" 
>
                                            messageID
                                        </a>
                                </li>
                                <li>
                                        <a href="#receiver" 
>
                                            receiver
                                        </a>
                                </li>
                                <li>
                                        <a href="#receiverID" 
>
                                            receiverID
                                        </a>
                                </li>
                                <li>
                                        <a href="#sender" 
>
                                            sender
                                        </a>
                                </li>
                                <li>
                                        <a href="#senderID" 
>
                                            senderID
                                        </a>
                                </li>
                                <li>
                                        <a href="#viewed" 
>
                                            viewed
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="createdAt"></a>
                                        <span class="name "><b>createdAt</b>
                                            <a href="#createdAt">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>createdAt:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" >Date</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" >Date</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="message"></a>
                                        <span class="name "><b>message</b>
                                            <a href="#message">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>message:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="messageID"></a>
                                        <span class="name "><b>messageID</b>
                                            <a href="#messageID">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>messageID:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="receiver"></a>
                                        <span class="name "><b>receiver</b>
                                            <a href="#receiver">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>receiver:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="receiverID"></a>
                                        <span class="name "><b>receiverID</b>
                                            <a href="#receiverID">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>receiverID:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="sender"></a>
                                        <span class="name "><b>sender</b>
                                            <a href="#sender">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>sender:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="senderID"></a>
                                        <span class="name "><b>senderID</b>
                                            <a href="#senderID">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>senderID:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="viewed"></a>
                                        <span class="name "><b>viewed</b>
                                            <a href="#viewed">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>viewed:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, ElementRef, HostListener, ViewChild } from &#x27;@angular/core&#x27;;
import { DbConnectionService } from &#x27;../services/db-connection.service&#x27;;
import { UserService } from &#x27;../services/user.service&#x27;;
import { ActivatedRoute } from &#x27;@angular/router&#x27;;

@Component({
  selector: &#x27;app-messages&#x27;,
  templateUrl: &#x27;./messages.component.html&#x27;,
  styleUrls: [&#x27;./messages.component.scss&#x27;]
})
export class MessagesComponent {
  @ViewChild(&#x27;chat&#x27;) private myScrollContainer: ElementRef;

  lastMessages: Message[] &#x3D; [];
  messages: Message[] &#x3D; [];
  message: string &#x3D; &quot;&quot;;

  selected: number &#x3D; -1;
  selectedUserName: string &#x3D; &quot;&quot;;

  locked: boolean &#x3D; false;
  scrollToBottomNeeded: boolean &#x3D; false;

  timeToRefresh &#x3D; 1000; // interval for data refreshing, time in ms
  interval;

  focus: boolean &#x3D; false;

  // enter focus mode when screen width is smaller than 1000 pixels
  @HostListener(&#x27;window:resize&#x27;, [&#x27;$event&#x27;])
  onResize(event) {
    this.focus &#x3D; window.innerWidth &lt; 1000;
  }

  constructor(
    private db: DbConnectionService,
    private route: ActivatedRoute,
    public user: UserService
  ) {
    // repeatedly check for new messages
    this.interval &#x3D; setInterval(() &#x3D;&gt; {
      this.fetchMessages();
    }, this.timeToRefresh);  
  }

  // scroll to bottom of chat after data change
  ngAfterViewChecked() {        
    if (this.scrollToBottomNeeded){
      this.scrollToBottom();
      this.scrollToBottomNeeded &#x3D; false;
    }        
  }

  // scrolls to bottom of chat
  scrollToBottom(): void {
    try {
        this.myScrollContainer.nativeElement.scrollTop &#x3D; this.myScrollContainer.nativeElement.scrollHeight;
    } catch(err) { }                 
  }

  ngOnInit() {
    this.db.getLastMessages(this.user.getLoginToken()).then(r &#x3D;&gt; this.lastMessages &#x3D; r[&#x27;messages&#x27;]);

    // get url query params
    this.route.queryParamMap.subscribe(qMap &#x3D;&gt; {
      // when query has &#x27;id&#x27; parameter show chat with user
      let uId &#x3D; qMap[&#x27;params&#x27;].id;
      if (uId){
        this.db.getUserData(uId, this.user.getLoginToken()).then(l &#x3D;&gt; {
          // enter focus mode when id is given
          this.focus &#x3D; true;
          this.selected &#x3D; parseInt(uId);
          this.selectedUserName &#x3D; l[&#x27;userName&#x27;];
          this.fetchMessages();
        })
      } else {
        // reset variables
        this.focus &#x3D; false;
        this.selected &#x3D; 1;
        this.messages &#x3D; [];
        this.message &#x3D; &quot;&quot;;
        this.selectedUserName &#x3D; &quot;&quot;;
      }
    })
  }

  // stop checking for new messages when leaving page
  ngOnDestroy(){
    clearInterval(this.interval)
  }

  // open chat window
  selectPerson(message: Message){
    if (this.locked)
      return;
    this.messages &#x3D; [];
    this.selected &#x3D; message.senderID &#x3D;&#x3D;&#x3D; this.user.getId() ? message.receiverID : message.senderID;
    this.selectedUserName &#x3D; message.senderID &#x3D;&#x3D;&#x3D; this.user.getId() ? message.receiver : message.sender;
    this.db.getMessages(this.user.getLoginToken(), this.selected).then(r &#x3D;&gt; {
      this.messages &#x3D; r[&#x27;messages&#x27;];
      this.scrollToBottomNeeded &#x3D; true;
    });
    this.message &#x3D; &quot;&quot;;
  }

  // update data
  fetchMessages(){
    // fetch last messages
    this.db.getLastMessages(this.user.getLoginToken()).then(r &#x3D;&gt; this.lastMessages &#x3D; r[&#x27;messages&#x27;]);
    if (this.selected &lt; 0)
      return;
    // fetch messages from open chat
    this.db.getMessages(this.user.getLoginToken(), this.selected).then(r &#x3D;&gt; {
      let m &#x3D; r[&#x27;messages&#x27;];
      // add message and scroll to bottom when new messages are fetched
      if (m.length &gt; this.messages.length){
        for (let i &#x3D; this.messages.length; i &lt; m.length; i++)
          this.messages.push(m[i]);
        this.scrollToBottomNeeded &#x3D; true;
      }
    });
  }

  // sends message on &quot;Enter&quot; keypress
  keyPressed(event){
    if(event.key &#x3D;&#x3D;&#x3D; &quot;Enter&quot;)
      this.sendMessage();
  }

  sendMessage(){
    this.locked &#x3D; true; // safety while sending message
    this.db.postMessage(this.user.getLoginToken(), this.selected, this.message).then(r &#x3D;&gt; {
      this.message &#x3D; &quot;&quot;; // clear input field
      // add new message locally
      let m &#x3D; r[&#x27;message&#x27;];
      this.messages.push(m);
      m.sender &#x3D; this.user.getUserName();
      m.receiver &#x3D; this.selectedUserName;
      this.moveLastMessageUp(m);
      this.locked &#x3D; false;
      this.scrollToBottomNeeded &#x3D; true;
    })
  }

  // move last message up when sending message
  moveLastMessageUp(m: Message){
    for (let i &#x3D; 0; i &lt; this.lastMessages.length; i++){
      if (this.lastMessages[i].receiverID &#x3D;&#x3D;&#x3D; this.selected || this.lastMessages[i].senderID &#x3D;&#x3D;&#x3D; this.selected){
        // set chat to top of recent messages list
        this.lastMessages.unshift(...this.lastMessages.splice(i, 1));
        // update last message
        this.lastMessages[0].message &#x3D; m.message;
        return;
      }
    }
    // When no previous message is found, add message
    this.lastMessages.unshift(m);
  }

  simplifyDate(d: string){
    return d.split(&quot;T&quot;)[0]
  }
}

export interface Message {
  messageID: number,
  receiverID: number,
  senderID: number,
  message: string,
  createdAt: Date,
  sender: string,
  receiver: string,
  viewed: boolean
}

</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'Message.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
